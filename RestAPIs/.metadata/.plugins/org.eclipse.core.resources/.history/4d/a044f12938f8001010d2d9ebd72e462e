package com.example.demo.services;

import java.sql.Date;
import java.time.LocalDate;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.example.demo.dto.LoginDTO;
import com.example.demo.dto.LoginResponseDTO;
import com.example.demo.dto.UserRegisterDTO;
import com.example.demo.dto.userResponseDTO;
import com.example.demo.entities.Area;
import com.example.demo.entities.Role;
import com.example.demo.entities.User;
import com.example.demo.repositories.AreaRepo;
import com.example.demo.repositories.RoleRepo;
import com.example.demo.repositories.UserRepo;

@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepo userRepository;

    @Autowired
    private RoleRepo roleRepository;

    @Autowired
    private AreaRepo areaRepository;

    @Override
    public userResponseDTO registerUser(UserRegisterDTO dto) {

        // 1) check if role exists
        Role role = roleRepository.findById(dto.getRoleId())
                .orElseThrow(() -> new RuntimeException("Role not found"));

        // 2) check if area exists
        Area area = areaRepository.findById(dto.getAreaId())
                .orElseThrow(() -> new RuntimeException("Area not found"));

        // 3) create user entity
        User user = new User();
        user.setUsername(dto.getUsername());
        user.setContact(dto.getContact());
        user.setEmail(dto.getEmail());
        user.setPassword(dto.getPassword());
        user.setRole(role);
        user.setArea(area);
        user.setCreatedAt(Date.valueOf(LocalDate.now()));
        user.setStatus(User.Status.ACTIVE);

        // 4) save user
        User savedUser = userRepository.save(user);

        // 5) response
        userResponseDTO response = new userResponseDTO();
        response.setId(savedUser.getId());
        response.setUsername(savedUser.getUsername());
        response.setEmail(savedUser.getEmail());
        response.setContact(savedUser.getContact());
        response.setRoleName(savedUser.getRole().getRoleName());
        response.setAreaName(savedUser.getArea().getAreaName());
        response.setStatus(savedUser.getStatus().name());

        return response;
    }

    @Override
    public LoginResponseDTO loginUser(LoginDTO dto) {

        // 1) Check if user exists by email
        User user = userRepository.findByEmail(dto.getEmail())
                .orElseThrow(() -> new RuntimeException("Invalid email or password"));

        // 2) Verify password
        if (!user.getPassword().equals(dto.getPassword())) {
            throw new RuntimeException("Invalid email or password");
        }

        // 3) Check user status
        if (user.getStatus() == User.Status.BLOCKED) {
            throw new RuntimeException("Your account is blocked");
        }

        // 4) Create response
        LoginResponseDTO response = new LoginResponseDTO();
        response.setUserId(user.getId());
        response.setUsername(user.getUsername());
        response.setEmail(user.getEmail());
        response.setRole(user.getRole().getRoleName());
        response.setArea(user.getArea().getAreaName());
        response.setStatus(LoginResponseDTO.Status.valueOf(user.getStatus().name()));
        response.setMessage("Login Successfully");


        return response;
    }
}
